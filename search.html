<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과 - GaNaDa</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="navigation.js"></script>
</head>
<body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style="font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif;">
        <div class="layout-container flex h-full grow flex-col min-h-screen">
            <div id="navigation-container"></div>

            <!-- Main Content -->
            <div class="px-4 md:px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                    <!-- Search Bar -->
                    <div class="px-4 py-3">
                        <label class="flex flex-col min-w-40 h-12 w-full">
                            <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                                <div class="text-[#637488] flex border-none bg-[#f0f2f4] items-center justify-center pl-4 rounded-l-xl border-r-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                        <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                                    </svg>
                                </div>
                                <input id="main-search" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111418] focus:outline-0 focus:ring-0 border-none bg-[#f0f2f4] focus:border-none h-full placeholder:text-[#637488] px-4 rounded-r-none border-r-0 pr-2 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" value="" placeholder="작품, 계정, 태그 검색">
                                <div class="flex items-center justify-center rounded-r-xl border-l-0 border-none bg-[#f0f2f4] pr-2 pr-4">
                                    <button id="clear-search" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full bg-transparent text-[#111418] gap-2 text-base font-bold leading-normal tracking-[0.015em] h-auto min-w-0 px-0">
                                        <div class="text-[#637488]">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                                <path d="M165.66,101.66,139.31,128l26.35,26.34a8,8,0,0,1-11.32,11.32L128,139.31l-26.34,26.35a8,8,0,0,1-11.32-11.32L116.69,128,90.34,101.66a8,8,0,0,1,11.32-11.32L128,116.69l26.34-26.35a8,8,0,0,1,11.32,11.32ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"></path>
                                            </svg>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="pb-3">
                        <div class="flex border-b border-[#dce0e5] px-4 gap-8">
                            <button class="search-tab flex flex-col items-center justify-center border-b-[3px] border-b-[#111418] text-[#111418] pb-[13px] pt-4" data-tab="top">
                                <p class="text-[#111418] text-sm font-bold leading-normal tracking-[0.015em]">인기</p>
                            </button>
                            <button class="search-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637488] pb-[13px] pt-4" data-tab="accounts">
                                <p class="text-[#637488] text-sm font-bold leading-normal tracking-[0.015em]">계정</p>
                            </button>
                            <button class="search-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637488] pb-[13px] pt-4" data-tab="tags">
                                <p class="text-[#637488] text-sm font-bold leading-normal tracking-[0.015em]">태그</p>
                            </button>
                        </div>
                    </div>

                    <!-- Search Results Grid -->
                    <div id="search-results" class="grid grid-cols-[repeat(auto-fit,minmax(180px,1fr))] md:grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-4 md:gap-3 p-4">
                        <!-- Results will be populated here -->
                    </div>

                    <!-- No Results Message -->
                    <div id="no-results" class="hidden flex flex-col items-center justify-center py-20">
                        <div class="text-[#637488] mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64px" height="64px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                            </svg>
                        </div>
                        <p class="text-[#637488] text-xl md:text-lg font-medium mb-2">검색 결과가 없습니다</p>
                        <p class="text-[#637488] text-base md:text-sm">다른 키워드로 검색해보세요</p>
                    </div>

                    <!-- Loading -->
                    <div id="loading" class="hidden flex items-center justify-center py-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#111418]"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer-container"></div>
    </div>

    <script>
        let currentTab = 'top';
        let currentQuery = '';
        let currentUser = null;
        let searchTimeout = null;

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 로그인 상태 확인
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                
                // 초기 인기 콘텐츠 로드
                await loadPopularContent();
                setupEventListeners();
                
            } catch (error) {
                console.error('페이지 로드 중 오류:', error);
                setupEventListeners();
            }
        });

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Clear search
            document.getElementById('clear-search').addEventListener('click', function() {
                document.getElementById('main-search').value = '';
                currentQuery = '';
                loadPopularContent();
            });

            // Search input with debounce
            document.getElementById('main-search').addEventListener('input', function() {
                const query = this.value.trim();
                currentQuery = query;
                
                // 디바운싱: 500ms 후에 검색 실행
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (query) {
                        performSearch(query);
                    } else {
                        loadPopularContent();
                    }
                }, 500);
            });

            // Enter key search
            document.getElementById('main-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    currentQuery = query;
                    if (query) {
                        performSearch(query);
                    } else {
                        loadPopularContent();
                    }
                }
            });
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab UI
            document.querySelectorAll('.search-tab').forEach(tab => {
                const isActive = tab.dataset.tab === tabName;
                tab.classList.toggle('border-b-[#111418]', isActive);
                tab.classList.toggle('border-b-transparent', !isActive);
                tab.classList.toggle('text-[#111418]', isActive);
                tab.classList.toggle('text-[#637488]', !isActive);
                
                const p = tab.querySelector('p');
                p.classList.toggle('text-[#111418]', isActive);
                p.classList.toggle('text-[#637488]', !isActive);
            });

            // 현재 검색어가 있으면 검색, 없으면 인기 콘텐츠 로드
            if (currentQuery) {
                performSearch(currentQuery);
            } else {
                loadPopularContent();
            }
        }

        // 인기 콘텐츠 로드 (검색어가 없을 때)
        async function loadPopularContent() {
            const loading = document.getElementById('loading');
            const resultsContainer = document.getElementById('search-results');
            const noResults = document.getElementById('no-results');

            loading.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            noResults.classList.add('hidden');

            try {
                let data = [];
                
                switch (currentTab) {
                    case 'top':
                        data = await loadPopularPosts();
                        break;
                    case 'accounts':
                        data = await loadPopularAccounts();
                        break;
                    case 'tags':
                        data = await loadPopularTags();
                        break;
                }

                displayResults(data);
                
            } catch (error) {
                console.error('인기 콘텐츠 로드 오류:', error);
                noResults.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // 실제 검색 수행
        async function performSearch(query) {
            if (!query.trim()) {
                loadPopularContent();
                return;
            }

            const loading = document.getElementById('loading');
            const resultsContainer = document.getElementById('search-results');
            const noResults = document.getElementById('no-results');

            loading.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            noResults.classList.add('hidden');

            try {
                let data = [];
                
                switch (currentTab) {
                    case 'top':
                        data = await searchPosts(query);
                        break;
                    case 'accounts':
                        data = await searchAccounts(query);
                        break;
                    case 'tags':
                        data = await searchTags(query);
                        break;
                }

                displayResults(data);
                
            } catch (error) {
                console.error('검색 오류:', error);
                noResults.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // 인기 작품 로드
        async function loadPopularPosts() {
            const { data: posts, error } = await supabase
                .from('posts')
                .select(`
                    *,
                    users:user_id (id, username, avatar_url)
                `)
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) throw error;

            // 각 포스트에 좋아요 수 추가
            for (let post of posts) {
                const { count } = await supabase
                    .from('post_likes')
                    .select('*', { count: 'exact' })
                    .eq('post_id', post.id);
                post.likes_count = count || 0;
            }

            // 좋아요 수로 정렬
            posts.sort((a, b) => b.likes_count - a.likes_count);

            return posts.map(post => ({
                type: 'artwork',
                id: post.id,
                image: post.image_url,
                title: post.title,
                likes: post.likes_count,
                user: post.users
            }));
        }

        // 인기 계정 로드
        async function loadPopularAccounts() {
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) throw error;

            // 각 사용자의 팔로워 수 계산
            for (let user of users) {
                const { count } = await supabase
                    .from('follows')
                    .select('*', { count: 'exact' })
                    .eq('following_id', user.id);
                user.followers_count = count || 0;

                // 현재 사용자가 이 사용자를 팔로우하는지 확인
                if (currentUser) {
                    const { data: followData } = await supabase
                        .from('follows')
                        .select('id')
                        .eq('follower_id', currentUser.id)
                        .eq('following_id', user.id)
                        .single();
                    user.is_following = !!followData;
                }
            }

            // 팔로워 수로 정렬
            users.sort((a, b) => b.followers_count - a.followers_count);

            return users.map(user => ({
                type: 'account',
                id: user.id,
                username: user.username,
                name: user.full_name || user.username,
                avatar: user.avatar_url || '/api/placeholder/64/64',
                followers: user.followers_count,
                is_following: user.is_following || false
            }));
        }

        // 인기 태그 로드 (임시로 더미 데이터)
        async function loadPopularTags() {
            // TODO: 실제 태그 시스템 구현 시 교체
            return [
                { type: 'tag', name: '#디지털아트', count: 150, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#일러스트', count: 89, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#포토그래피', count: 67, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#추상화', count: 45, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#풍경화', count: 32, preview: '/api/placeholder/200/200' }
            ];
        }

        // 작품 검색
        async function searchPosts(query) {
            const { data: posts, error } = await supabase
                .from('posts')
                .select(`
                    *,
                    users:user_id (id, username, avatar_url)
                `)
                .or(`title.ilike.%${query}%,description.ilike.%${query}%`)
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) throw error;

            // 각 포스트에 좋아요 수 추가
            for (let post of posts) {
                const { count } = await supabase
                    .from('post_likes')
                    .select('*', { count: 'exact' })
                    .eq('post_id', post.id);
                post.likes_count = count || 0;
            }

            return posts.map(post => ({
                type: 'artwork',
                id: post.id,
                image: post.image_url,
                title: post.title,
                likes: post.likes_count,
                user: post.users
            }));
        }

        // 계정 검색
        async function searchAccounts(query) {
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .or(`username.ilike.%${query}%,full_name.ilike.%${query}%`)
                .limit(50);

            if (error) throw error;

            // 각 사용자의 팔로워 수 계산
            for (let user of users) {
                const { count } = await supabase
                    .from('follows')
                    .select('*', { count: 'exact' })
                    .eq('following_id', user.id);
                user.followers_count = count || 0;

                // 현재 사용자가 이 사용자를 팔로우하는지 확인
                if (currentUser) {
                    const { data: followData } = await supabase
                        .from('follows')
                        .select('id')
                        .eq('follower_id', currentUser.id)
                        .eq('following_id', user.id)
                        .single();
                    user.is_following = !!followData;
                }
            }

            return users.map(user => ({
                type: 'account',
                id: user.id,
                username: user.username,
                name: user.full_name || user.username,
                avatar: user.avatar_url || '/api/placeholder/64/64',
                followers: user.followers_count,
                is_following: user.is_following || false
            }));
        }

        // 태그 검색 (임시로 더미 데이터)
        async function searchTags(query) {
            // TODO: 실제 태그 시스템 구현 시 교체
            const allTags = [
                { type: 'tag', name: '#디지털아트', count: 150, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#일러스트', count: 89, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#포토그래피', count: 67, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#추상화', count: 45, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#풍경화', count: 32, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#인물화', count: 28, preview: '/api/placeholder/200/200' },
                { type: 'tag', name: '#수채화', count: 24, preview: '/api/placeholder/200/200' }
            ];

            return allTags.filter(tag => 
                tag.name.toLowerCase().includes(query.toLowerCase())
            );
        }

        // 검색 결과 표시
        function displayResults(data) {
            const resultsContainer = document.getElementById('search-results');
            const noResults = document.getElementById('no-results');

            if (data.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }

            resultsContainer.innerHTML = data.map(item => {
                switch (item.type) {
                    case 'artwork':
                        return `
                            <div class="flex flex-col gap-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="viewArtwork(${item.id})">
                                <div class="w-full bg-center bg-no-repeat aspect-square bg-cover" style="background-image: url('${item.image}')"></div>
                                <div class="flex items-center gap-2">
                                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-6 w-6" style="background-image: url('${item.user?.avatar_url || '/api/placeholder/24/24'}')"></div>
                                    <p class="text-xs text-[#637488] truncate">${item.user?.username || '익명'}</p>
                                    <div class="flex items-center gap-1 ml-auto">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" fill="currentColor" viewBox="0 0 256 256">
                                            <path d="M240,102c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,228.66,16,172,16,102A62.07,62.07,0,0,1,78,40c20.65,0,38.73,8.88,50,23.89C139.27,48.88,157.35,40,178,40A62.07,62.07,0,0,1,240,102Z"></path>
                                        </svg>
                                        <span class="text-xs text-[#637488]">${item.likes || 0}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    case 'account':
                        const followButtonText = item.is_following ? '팔로잉' : '팔로우';
                        const followButtonClass = item.is_following 
                            ? 'px-4 py-1 text-xs font-medium rounded-lg bg-[#6b7280] text-white hover:bg-[#4b5563] transition-colors'
                            : 'px-4 py-1 text-xs font-medium rounded-lg bg-[#ff8c00] text-white hover:bg-[#e67e00] transition-colors';
                        
                        return `
                            <div class="flex flex-col items-center p-4 bg-[#f8f9fa] rounded-xl hover:bg-[#f0f2f4] transition-colors">
                                <div class="w-16 h-16 bg-center bg-no-repeat bg-cover rounded-full mb-3 cursor-pointer" style="background-image: url('${item.avatar}')" onclick="viewProfile('${item.id}')"></div>
                                <p class="text-sm font-bold text-[#111418] mb-1 cursor-pointer text-center" onclick="viewProfile('${item.id}')">${item.name}</p>
                                <p class="text-xs text-[#637488] mb-2 cursor-pointer text-center" onclick="viewProfile('${item.id}')">@${item.username}</p>
                                <p class="text-xs text-[#637488] mb-3">팔로워 ${item.followers}</p>
                                ${currentUser && currentUser.id !== item.id ? `
                                    <button class="${followButtonClass}" onclick="toggleFollowFromSearch('${item.id}', this)">
                                        ${followButtonText}
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    case 'tag':
                        return `
                            <div class="flex flex-col cursor-pointer hover:opacity-80 transition-opacity" onclick="searchTag('${item.name}')">
                                <div class="w-full bg-center bg-no-repeat aspect-square bg-cover mb-3 rounded-lg" style="background-image: url('${item.preview}')"></div>
                                <p class="text-sm font-bold text-[#111418] mb-1">${item.name}</p>
                                <p class="text-xs text-[#637488]">${item.count}개 게시물</p>
                            </div>
                        `;
                    default:
                        return '';
                }
            }).join('');
        }

        // 팔로우 토글
        async function toggleFollowFromSearch(userId, buttonElement) {
            if (!currentUser) {
                alert('팔로우하려면 로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }

            if (currentUser.id === userId) {
                alert('자기 자신을 팔로우할 수 없습니다.');
                return;
            }

            const originalText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = '처리 중...';

            try {
                const isCurrentlyFollowing = originalText === '팔로잉';
                
                if (isCurrentlyFollowing) {
                    // 언팔로우
                    const { error } = await supabase
                        .from('follows')
                        .delete()
                        .eq('follower_id', currentUser.id)
                        .eq('following_id', userId);
                    
                    if (error) throw error;
                    
                    buttonElement.textContent = '팔로우';
                    buttonElement.className = 'px-4 py-1 text-xs font-medium rounded-lg bg-[#ff8c00] text-white hover:bg-[#e67e00] transition-colors';
                } else {
                    // 팔로우
                    const { error } = await supabase
                        .from('follows')
                        .insert({
                            follower_id: currentUser.id,
                            following_id: userId
                        });
                    
                    if (error) throw error;
                    
                    buttonElement.textContent = '팔로잉';
                    buttonElement.className = 'px-4 py-1 text-xs font-medium rounded-lg bg-[#6b7280] text-white hover:bg-[#4b5563] transition-colors';
                }
                
            } catch (error) {
                console.error('팔로우 토글 오류:', error);
                alert('팔로우 처리 중 오류가 발생했습니다.');
                buttonElement.textContent = originalText;
            } finally {
                buttonElement.disabled = false;
            }
        }

        // 네비게이션 함수들
        function viewArtwork(id) {
            window.location.href = `artwork.html?id=${id}`;
        }

        function viewProfile(userId) {
            window.location.href = `profile.html?id=${userId}`;
        }

        function searchTag(tag) {
            document.getElementById('main-search').value = tag;
            currentQuery = tag;
            switchTab('top');
        }

        // Initialize navigation
        initNavigation('search');
    </script>
</body>
</html> 