<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¼ - GaNaDa</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800">
    <script src="error-handler.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="navigation.js"></script>
</head>
<body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style="font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif;">
        <div class="layout-container flex h-full grow flex-col min-h-screen">
            <div id="navigation-container"></div>

            <!-- Main Content -->
            <div class="px-4 md:px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                    
                    <!-- Header -->
                    <div class="flex flex-wrap justify-between items-center gap-3 p-4">
                        <h1 class="text-[#121416] tracking-light text-3xl md:text-[32px] font-bold leading-tight">ì•Œë¦¼</h1>
                        <div class="flex items-center gap-2">
                            <!-- ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ ë²„íŠ¼ -->
                            <button id="mark-all-read" class="hidden px-4 py-2 text-sm font-medium text-[#637488] hover:text-[#121416] hover:bg-gray-100 rounded-lg transition-colors">
                                ëª¨ë‘ ì½ìŒ
                            </button>
                            <!-- ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ -->
                            <span id="unread-count" class="hidden px-2 py-1 text-xs font-bold text-white bg-red-500 rounded-full"></span>
                        </div>
                    </div>

                    <!-- í•„í„° íƒ­ -->
                    <div class="px-4 pb-3">
                        <div class="flex border-b border-[#dce0e5] gap-6">
                            <button class="notification-tab flex flex-col items-center justify-center border-b-[3px] border-b-[#121416] text-[#121416] pb-[13px] pt-4" data-filter="all">
                                <p class="text-[#121416] text-sm font-bold leading-normal tracking-[0.015em]">ì „ì²´</p>
                            </button>
                            <button class="notification-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637488] pb-[13px] pt-4" data-filter="like">
                                <p class="text-[#637488] text-sm font-bold leading-normal tracking-[0.015em]">ì¢‹ì•„ìš”</p>
                            </button>
                            <button class="notification-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637488] pb-[13px] pt-4" data-filter="comment">
                                <p class="text-[#637488] text-sm font-bold leading-normal tracking-[0.015em]">ëŒ“ê¸€</p>
                            </button>
                            <button class="notification-tab flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637488] pb-[13px] pt-4" data-filter="follow">
                                <p class="text-[#637488] text-sm font-bold leading-normal tracking-[0.015em]">íŒ”ë¡œìš°</p>
                            </button>
                        </div>
                    </div>

                    <!-- ì•Œë¦¼ ëª©ë¡ -->
                    <div id="notifications-container" class="flex flex-col">
                        <!-- ì•Œë¦¼ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>

                    <!-- ë¡œë”© ìƒíƒœ -->
                    <div id="loading" class="flex items-center justify-center py-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#121416]"></div>
                    </div>

                    <!-- ë¹ˆ ìƒíƒœ -->
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20">
                        <div class="text-[#637488] mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64px" height="64px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"></path>
                            </svg>
                        </div>
                        <p class="text-[#637488] text-xl md:text-lg font-medium mb-2">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-[#637488] text-base md:text-sm">ìƒˆë¡œìš´ í™œë™ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>

                    <!-- ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
                    <div id="load-more-container" class="hidden flex justify-center p-4">
                        <button id="load-more-btn" class="px-6 py-3 text-sm font-medium text-[#121416] border border-[#dce0e5] rounded-lg hover:bg-gray-50 transition-colors">
                            ë” ë§ì€ ì•Œë¦¼ ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer-container"></div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentFilter = 'all';
        let currentPage = 0;
        let isLoading = false;
        let hasMoreNotifications = true;
        const NOTIFICATIONS_PER_PAGE = 20;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                initNavigation('notifications');
                
                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                
                if (!currentUser) {
                    alert('ì•Œë¦¼ì„ í™•ì¸í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // ì´ˆê¸° ì•Œë¦¼ ë¡œë“œ
                await loadNotifications();
                setupEventListeners();
                setupRealtimeSubscription();
                
            } catch (error) {
                console.error('í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                showEmptyState();
            }
        });

        function setupEventListeners() {
            // í•„í„° íƒ­ ì´ë²¤íŠ¸
            document.querySelectorAll('.notification-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    switchFilter(filter);
                });
            });

            // ëª¨ë‘ ì½ìŒ ì²˜ë¦¬
            document.getElementById('mark-all-read').addEventListener('click', markAllAsRead);

            // ë” ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('load-more-btn').addEventListener('click', loadMoreNotifications);
        }

        // í•„í„° ì „í™˜
        function switchFilter(filter) {
            currentFilter = filter;
            currentPage = 0;
            hasMoreNotifications = true;
            
            // íƒ­ UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.notification-tab').forEach(tab => {
                const isActive = tab.dataset.filter === filter;
                tab.classList.toggle('border-b-[#121416]', isActive);
                tab.classList.toggle('border-b-transparent', !isActive);
                tab.classList.toggle('text-[#121416]', isActive);
                tab.classList.toggle('text-[#637488]', !isActive);
                
                const p = tab.querySelector('p');
                p.classList.toggle('text-[#121416]', isActive);
                p.classList.toggle('text-[#637488]', !isActive);
            });

            // ì•Œë¦¼ ë‹¤ì‹œ ë¡œë“œ
            loadNotifications();
        }

        // ì•Œë¦¼ ë¡œë“œ
        async function loadNotifications(page = 0) {
            if (isLoading) return;
            
            isLoading = true;
            const loading = document.getElementById('loading');
            const container = document.getElementById('notifications-container');
            const emptyState = document.getElementById('empty-state');
            const loadMoreContainer = document.getElementById('load-more-container');

            if (page === 0) {
                loading.classList.remove('hidden');
                container.innerHTML = '';
                emptyState.classList.add('hidden');
                loadMoreContainer.classList.add('hidden');
            }

            try {
                let query = supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .range(page * NOTIFICATIONS_PER_PAGE, (page + 1) * NOTIFICATIONS_PER_PAGE - 1);

                // í•„í„° ì ìš©
                if (currentFilter !== 'all') {
                    query = query.eq('type', currentFilter);
                }

                const { data: notifications, error } = await query;

                if (error) throw error;

                if (notifications && notifications.length > 0) {
                    // ê° ì•Œë¦¼ì— ëŒ€í•´ ì¶”ê°€ ì •ë³´ ë¡œë“œ
                    for (let notification of notifications) {
                        // ë°œì‹ ì ì •ë³´ ë¡œë“œ
                        if (notification.related_user_id) {
                            const { data: sender } = await supabase
                                .from('users')
                                .select('id, username, avatar_url')
                                .eq('id', notification.related_user_id)
                                .single();
                            notification.sender = sender;
                        }

                        // ê´€ë ¨ í¬ìŠ¤íŠ¸ ì •ë³´ ë¡œë“œ
                        if (notification.related_post_id) {
                            const { data: post } = await supabase
                                .from('posts')
                                .select('id, image_url, title')
                                .eq('id', notification.related_post_id)
                                .single();
                            notification.related_post = post;
                        }

                        const notificationElement = createNotificationCard(notification);
                        container.appendChild(notificationElement);
                    }

                    hasMoreNotifications = notifications.length === NOTIFICATIONS_PER_PAGE;
                    currentPage = page;

                    // ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í‘œì‹œ
                    if (hasMoreNotifications) {
                        loadMoreContainer.classList.remove('hidden');
                    }

                    // ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸
                    updateUnreadCount();
                } else {
                    hasMoreNotifications = false;
                    if (page === 0) {
                        showEmptyState();
                    }
                }

            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                if (page === 0) {
                    showEmptyState();
                }
            } finally {
                loading.classList.add('hidden');
                isLoading = false;
            }
        }

        // ë” ë§ì€ ì•Œë¦¼ ë¡œë“œ
        async function loadMoreNotifications() {
            if (!hasMoreNotifications || isLoading) return;
            
            const button = document.getElementById('load-more-btn');
            const originalText = button.textContent;
            button.textContent = 'ë¡œë”© ì¤‘...';
            button.disabled = true;

            try {
                await loadNotifications(currentPage + 1);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
                
                if (!hasMoreNotifications) {
                    document.getElementById('load-more-container').classList.add('hidden');
                }
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
        function getNotificationMessage(notification) {
            const senderName = notification.sender?.username || 'ì‚¬ìš©ì';
            
            switch (notification.type) {
                case 'like':
                    return `${senderName}ë‹˜ì´ íšŒì›ë‹˜ì˜ ì‘í’ˆì„ ì¢‹ì•„í•©ë‹ˆë‹¤`;
                case 'comment':
                    return `${senderName}ë‹˜ì´ íšŒì›ë‹˜ì˜ ì‘í’ˆì— ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤`;
                case 'follow':
                    return `${senderName}ë‹˜ì´ íšŒì›ë‹˜ì„ íŒ”ë¡œìš°í•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤`;
                default:
                    return notification.content || 'ìƒˆë¡œìš´ í™œë™ì´ ìˆìŠµë‹ˆë‹¤';
            }
        }

        // ì•Œë¦¼ ì¹´ë“œ ìƒì„±
        function createNotificationCard(notification) {
            const div = document.createElement('div');
            div.className = `notification-item flex items-start gap-4 p-4 border-b border-[#f0f2f4] hover:bg-gray-50 transition-colors cursor-pointer ${!notification.read ? 'bg-blue-50' : ''}`;
            div.dataset.notificationId = notification.id;
            div.onclick = () => handleNotificationClick(notification);

            // ì•Œë¦¼ íƒ€ì…ë³„ ì•„ì´ì½˜
            const iconMap = {
                like: { icon: 'â¤ï¸', color: 'text-red-500' },
                comment: { icon: 'ğŸ’¬', color: 'text-blue-500' },
                follow: { icon: 'ğŸ‘¤', color: 'text-green-500' },
                post: { icon: 'ğŸ“·', color: 'text-purple-500' }
            };

            const typeInfo = iconMap[notification.type] || { icon: 'ğŸ””', color: 'text-gray-500' };

            div.innerHTML = `
                <div class="flex-shrink-0">
                    ${notification.sender?.avatar_url ? 
                        `<div class="w-12 h-12 bg-center bg-no-repeat bg-cover rounded-full" style="background-image: url('${notification.sender.avatar_url}')"></div>` :
                        `<div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-lg">${typeInfo.icon}</div>`
                    }
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-[#121416] mb-1">${notification.content || 'ìƒˆë¡œìš´ ì•Œë¦¼'}</p>
                            <p class="text-sm text-[#637488] leading-relaxed">${getNotificationMessage(notification)}</p>
                            <p class="text-xs text-[#9ca3af] mt-2">${formatTimeAgo(notification.created_at)}</p>
                        </div>
                        ${notification.related_post?.image_url ? 
                            `<div class="w-12 h-12 bg-center bg-no-repeat bg-cover rounded ml-4" style="background-image: url('${notification.related_post.image_url}')"></div>` :
                            ''
                        }
                    </div>
                    ${!notification.read ? 
                        `<div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>` :
                        ''
                    }
                </div>
            `;

            return div;
        }

        // ì•Œë¦¼ í´ë¦­ ì²˜ë¦¬
        async function handleNotificationClick(notification) {
            try {
                // ì½ìŒ ì²˜ë¦¬
                if (!notification.read) {
                    await markAsRead(notification.id);
                }

                // ê´€ë ¨ í˜ì´ì§€ë¡œ ì´ë™
                if (notification.type === 'follow') {
                    if (notification.sender) {
                        window.location.href = `profile.html?user=${notification.sender.username}`;
                    }
                } else if (notification.related_post_id) {
                    window.location.href = `artwork.html?id=${notification.related_post_id}`;
                }

            } catch (error) {
                console.error('ì•Œë¦¼ í´ë¦­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // ê°œë³„ ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
        async function markAsRead(notificationId) {
            try {
                const { error } = await supabase
                    .from('notifications')
                    .update({ read: true })
                    .eq('id', notificationId);

                if (error) throw error;

                // UI ì—…ë°ì´íŠ¸
                const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationElement) {
                    notificationElement.classList.remove('bg-blue-50');
                    const unreadDot = notificationElement.querySelector('.bg-blue-500');
                    if (unreadDot) {
                        unreadDot.remove();
                    }
                }

                updateUnreadCount();

            } catch (error) {
                console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
        async function markAllAsRead() {
            try {
                const { error } = await supabase
                    .from('notifications')
                    .update({ read: true })
                    .eq('user_id', currentUser.id)
                    .eq('read', false);

                if (error) throw error;

                // UI ì—…ë°ì´íŠ¸
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('bg-blue-50');
                    const unreadDot = item.querySelector('.bg-blue-500');
                    if (unreadDot) {
                        unreadDot.remove();
                    }
                });

                updateUnreadCount();

            } catch (error) {
                console.error('ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸
        async function updateUnreadCount() {
            try {
                const { count, error } = await supabase
                    .from('notifications')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id)
                    .eq('read', false);

                if (error) throw error;

                const unreadCountElement = document.getElementById('unread-count');
                const markAllReadBtn = document.getElementById('mark-all-read');

                if (count > 0) {
                    unreadCountElement.textContent = count;
                    unreadCountElement.classList.remove('hidden');
                    markAllReadBtn.classList.remove('hidden');
                } else {
                    unreadCountElement.classList.add('hidden');
                    markAllReadBtn.classList.add('hidden');
                }

            } catch (error) {
                console.error('ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹¤ì‹œê°„ ì•Œë¦¼ êµ¬ë…
        function setupRealtimeSubscription() {
            if (!currentUser) return;

            const subscription = supabase
                .channel('notifications')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'notifications',
                    filter: `user_id=eq.${currentUser.id}`
                }, (payload) => {
                    console.log('ìƒˆë¡œìš´ ì•Œë¦¼:', payload.new);
                    handleNewNotification(payload.new);
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'notifications',
                    filter: `user_id=eq.${currentUser.id}`
                }, (payload) => {
                    console.log('ì•Œë¦¼ ì—…ë°ì´íŠ¸:', payload.new);
                    updateUnreadCount();
                })
                .subscribe();
        }

        // ìƒˆë¡œìš´ ì•Œë¦¼ ì²˜ë¦¬
        async function handleNewNotification(notification) {
            // í˜„ì¬ í•„í„°ì— ë§ëŠ” ì•Œë¦¼ì¸ì§€ í™•ì¸
            if (currentFilter === 'all' || currentFilter === notification.type) {
                // ì•Œë¦¼ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data: fullNotification, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('id', notification.id)
                    .single();

                if (!error && fullNotification) {
                    // ë°œì‹ ì ì •ë³´ ë¡œë“œ
                    if (fullNotification.related_user_id) {
                        const { data: sender } = await supabase
                            .from('users')
                            .select('id, username, avatar_url')
                            .eq('id', fullNotification.related_user_id)
                            .single();
                        fullNotification.sender = sender;
                    }

                    // ê´€ë ¨ í¬ìŠ¤íŠ¸ ì •ë³´ ë¡œë“œ
                    if (fullNotification.related_post_id) {
                        const { data: post } = await supabase
                            .from('posts')
                            .select('id, image_url, title')
                            .eq('id', fullNotification.related_post_id)
                            .single();
                        fullNotification.related_post = post;
                    }

                    // ë§¨ ìœ„ì— ìƒˆ ì•Œë¦¼ ì¶”ê°€
                    const container = document.getElementById('notifications-container');
                    const notificationElement = createNotificationCard(fullNotification);
                    container.insertBefore(notificationElement, container.firstChild);

                    // ë¹ˆ ìƒíƒœ ìˆ¨ê¸°ê¸°
                    document.getElementById('empty-state').classList.add('hidden');
                }
            }

            // ì•ˆì½ì€ ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸
            updateUnreadCount();
        }

        // ë¹ˆ ìƒíƒœ í‘œì‹œ
        function showEmptyState() {
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('notifications-container').innerHTML = '';
        }

        // ì‹œê°„ í¬ë§·íŒ…
        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) {
                return 'ë°©ê¸ˆ ì „';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}ë¶„ ì „`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}ì‹œê°„ ì „`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}ì¼ ì „`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }
    </script>
</body>
</html> 