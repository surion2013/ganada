<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />

    <title>GaNaDa - Explore</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="navigation.js"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col min-h-screen">
        <div id="navigation-container"></div>
        <div class="px-4 md:px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">

            <h2 class="text-[#121416] text-2xl md:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">ì¸ê¸° ì‘í’ˆ</h2>
            
            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="loading-posts" class="flex items-center justify-center py-20">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#121416]"></div>
            </div>
            
            <!-- ì‘í’ˆ ê·¸ë¦¬ë“œ -->
            <div class="grid grid-cols-[repeat(auto-fit,minmax(180px,1fr))] md:grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-4 md:gap-3 p-4" id="explore-posts">
              <!-- Posts will be loaded from Supabase -->
            </div>
            
            <!-- ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
            <div class="hidden flex flex-col items-center justify-center py-20 col-span-full" id="empty-state">
              <div class="text-[#6a7581] mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="64px" height="64px" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                </svg>
              </div>
              <p class="text-[#6a7581] text-xl md:text-lg font-medium mb-2">íƒìƒ‰í•  ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
              <p class="text-[#6a7581] text-base md:text-sm">ìƒˆë¡œìš´ ì‘í’ˆë“¤ì´ ê³§ ì—…ë¡œë“œë  ì˜ˆì •ì…ë‹ˆë‹¤</p>
            </div>
            
            <!-- ë” ë¶ˆëŸ¬ì˜¤ê¸° ë¡œë”© -->
            <div id="loading-more" class="hidden flex items-center justify-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#121416]"></div>
            </div>
            <h2 class="text-[#121416] text-2xl md:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸</h2>
            
            <!-- ì•„í‹°ìŠ¤íŠ¸ ë¡œë”© ìƒíƒœ -->
            <div id="loading-artists" class="flex items-center justify-center p-4">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#121416]"></div>
            </div>
            
            <!-- ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ ëª©ë¡ -->
            <div class="flex overflow-x-auto [-ms-scrollbar-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden gap-4 px-4 pb-4" id="recommended-artists">
              <!-- Artists will be loaded from Supabase -->
            </div>
            
            <!-- ì•„í‹°ìŠ¤íŠ¸ ë¹ˆ ìƒíƒœ -->
            <div class="hidden flex items-center justify-center p-4 w-full" id="empty-artists">
              <p class="text-[#6a7581] text-base md:text-sm">ì¶”ì²œí•  ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
          </div>
        </div>
        <div id="footer-container"></div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let currentPage = 0;
      let isLoading = false;
      let hasMorePosts = true;
      const POSTS_PER_PAGE = 12;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        initNavigation('explore');
        loadPopularPosts();
        loadRecommendedArtists();
        setupInfiniteScroll();
      });

      // 1. ì¸ê¸°ìˆœ ì‘í’ˆ ë¡œë”© (ì¢‹ì•„ìš” ìˆ˜ ê¸°ì¤€)
      async function loadPopularPosts(page = 0) {
        if (isLoading || !hasMorePosts) return;
        
        isLoading = true;
        const loadingElement = page === 0 ? document.getElementById('loading-posts') : document.getElementById('loading-more');
        const postsContainer = document.getElementById('explore-posts');
        const emptyState = document.getElementById('empty-state');

        // ë¡œë”© í‘œì‹œ
        if (page === 0) {
          loadingElement.classList.remove('hidden');
          emptyState.classList.add('hidden');
        } else {
          loadingElement.classList.remove('hidden');
        }

        try {
          // Supabaseì—ì„œ ì¸ê¸° ì‘í’ˆ ê°€ì ¸ì˜¤ê¸° (ì¢‹ì•„ìš” ìˆ˜ ê¸°ì¤€ ì •ë ¬)
          const { data: posts, error } = await supabase
            .from('posts')
            .select(`
              *,
              users (
                id,
                username,
                avatar_url
              )
            `)
            .order('likes_count', { ascending: false })
            .order('created_at', { ascending: false })
            .range(page * POSTS_PER_PAGE, (page + 1) * POSTS_PER_PAGE - 1);

          if (error) {
            console.error('Error loading posts:', error);
            throw error;
          }

          // ì²« í˜ì´ì§€ì¸ ê²½ìš° ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
          if (page === 0) {
            postsContainer.innerHTML = '';
          }

          if (posts && posts.length > 0) {
            // ì‘í’ˆ ì¹´ë“œë“¤ ìƒì„±
            posts.forEach(post => {
              const postElement = createPostCard(post);
              postsContainer.appendChild(postElement);
            });

            // ë” ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            hasMorePosts = posts.length === POSTS_PER_PAGE;
            currentPage = page;
          } else {
            hasMorePosts = false;
            if (page === 0) {
              emptyState.classList.remove('hidden');
            }
          }

        } catch (error) {
          console.error('Error loading popular posts:', error);
          if (page === 0) {
            emptyState.classList.remove('hidden');
          }
        } finally {
          // ë¡œë”© ìˆ¨ê¸°ê¸°
          loadingElement.classList.add('hidden');
          isLoading = false;
        }
      }

      // ì‘í’ˆ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
      function createPostCard(post) {
        const postDiv = document.createElement('div');
        postDiv.className = 'flex flex-col gap-3 cursor-pointer hover:opacity-80 transition-opacity';
        postDiv.onclick = () => viewArtwork(post.id);

        postDiv.innerHTML = `
          <div class="w-full bg-center bg-no-repeat aspect-square bg-cover bg-gray-200" 
               style="background-image: url('${post.image_url || 'https://via.placeholder.com/300x300?text=No+Image'}')">
          </div>
          <div class="flex items-center gap-2 px-2">
            <div class="w-6 h-6 bg-center bg-no-repeat bg-cover rounded-full bg-gray-300" 
                 style="background-image: url('${post.users?.avatar_url || 'https://via.placeholder.com/24x24?text=ğŸ‘¤'}')">
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-[#121416] truncate">${post.users?.username || 'Unknown'}</p>
            </div>
            <div class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="12px" height="12px" fill="currentColor" viewBox="0 0 256 256" class="text-red-500">
                <path d="M240,94c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,220.66,16,164,16,94A62.07,62.07,0,0,1,78,32c20.65,0,38.73,8.88,50,23.89C139.27,40.88,157.35,32,178,32A62.07,62.07,0,0,1,240,94Z"></path>
              </svg>
              <span class="text-xs text-[#6a7581]">${post.likes_count || 0}</span>
            </div>
          </div>
        `;

        return postDiv;
      }

      // 4. íŒ”ë¡œì›Œ ìˆ˜ ê¸°ë°˜ ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ ë¡œë”©
      async function loadRecommendedArtists() {
        const loadingElement = document.getElementById('loading-artists');
        const artistsContainer = document.getElementById('recommended-artists');
        const emptyState = document.getElementById('empty-artists');

        loadingElement.classList.remove('hidden');
        emptyState.classList.add('hidden');

        try {
          // Supabaseì—ì„œ íŒ”ë¡œì›Œ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ìƒìœ„ ì•„í‹°ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          const { data: artists, error } = await supabase
            .from('users')
            .select('*')
            .order('followers_count', { ascending: false })
            .limit(10);

          if (error) {
            console.error('Error loading artists:', error);
            throw error;
          }

          artistsContainer.innerHTML = '';

          if (artists && artists.length > 0) {
            artists.forEach(artist => {
              const artistCard = createArtistCard(artist);
              artistsContainer.appendChild(artistCard);
            });
          } else {
            emptyState.classList.remove('hidden');
          }

        } catch (error) {
          console.error('Error loading recommended artists:', error);
          emptyState.classList.remove('hidden');
        } finally {
          loadingElement.classList.add('hidden');
        }
      }

      // ì•„í‹°ìŠ¤íŠ¸ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
      function createArtistCard(artist) {
        const artistDiv = document.createElement('div');
        artistDiv.className = 'flex flex-col items-center p-4 bg-[#f8f9fa] rounded-xl hover:bg-[#f0f2f4] transition-colors cursor-pointer min-w-[140px]';
        artistDiv.onclick = () => viewProfile(artist.id);

        artistDiv.innerHTML = `
          <div class="w-16 h-16 bg-center bg-no-repeat bg-cover rounded-full mb-3 bg-gray-300" 
               style="background-image: url('${artist.avatar_url || 'https://via.placeholder.com/64x64?text=ğŸ‘¤'}')">
          </div>
          <p class="text-sm font-bold text-[#121416] mb-1 text-center truncate w-full">${artist.username || 'Unknown'}</p>
          <p class="text-xs text-[#6a7581] mb-2 text-center">íŒ”ë¡œì›Œ ${(artist.followers_count || 0).toLocaleString()}ëª…</p>
          <button class="px-3 py-1 text-xs font-medium rounded-lg bg-[#ff8c00] text-white hover:bg-[#e67e00] transition-colors"
                  onclick="event.stopPropagation(); followArtist('${artist.id}', this)">
            íŒ”ë¡œìš°
          </button>
        `;

        return artistDiv;
      }

      // 3. ë¬´í•œ ìŠ¤í¬ë¡¤ ì„¤ì •
      function setupInfiniteScroll() {
        window.addEventListener('scroll', () => {
          if (isLoading || !hasMorePosts) return;

          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.scrollHeight;

          // í˜ì´ì§€ í•˜ë‹¨ì—ì„œ 200px ì „ì— ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
          if (scrollTop + windowHeight >= documentHeight - 200) {
            loadPopularPosts(currentPage + 1);
          }
        });
      }

      // ì•„í‹°ìŠ¤íŠ¸ íŒ”ë¡œìš° í•¨ìˆ˜
      async function followArtist(artistId, buttonElement) {
        const currentUser = JSON.parse(localStorage.getItem('ganada-user') || '{}');
        
        if (!currentUser.id) {
          alert('íŒ”ë¡œìš°í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }

        if (currentUser.id === artistId) {
          alert('ìê¸° ìì‹ ì„ íŒ”ë¡œìš°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const originalText = buttonElement.textContent;
        buttonElement.disabled = true;
        buttonElement.textContent = 'ì²˜ë¦¬ ì¤‘...';

        try {
          const result = await SupabaseClient.Database.toggleFollow(currentUser.id, artistId);
          
          if (result.success) {
            if (result.following) {
              buttonElement.textContent = 'íŒ”ë¡œì‰';
              buttonElement.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-[#6b7280] text-white hover:bg-[#4b5563] transition-colors';
            } else {
              buttonElement.textContent = 'íŒ”ë¡œìš°';
              buttonElement.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-[#ff8c00] text-white hover:bg-[#e67e00] transition-colors';
            }
          } else {
            alert('íŒ”ë¡œìš° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            buttonElement.textContent = originalText;
          }
        } catch (error) {
          console.error('Follow error:', error);
          alert('íŒ”ë¡œìš° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          buttonElement.textContent = originalText;
        } finally {
          buttonElement.disabled = false;
        }
      }

      // ì‘í’ˆ ìƒì„¸ ë³´ê¸°
      function viewArtwork(postId) {
        window.location.href = `artwork.html?id=${postId}`;
      }

      // í”„ë¡œí•„ ë³´ê¸°
      function viewProfile(userId) {
        window.location.href = `profile.html?user=${userId}`;
      }

      // ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©)
      function refreshExplore() {
        currentPage = 0;
        hasMorePosts = true;
        loadPopularPosts(0);
        loadRecommendedArtists();
      }
    </script>
  </body>
</html> 